# {{ ansible_managed }}

##
## Allgemeines
##

# Muss erste Variable in Config file sein
dovecot_config_version=2.4.1

# Storage Version synchron mit Dovecot Version halten
dovecot_storage_version=2.4.1

# Aktivierte Protokolle
protocols = imap lmtp sieve 

# Verschlüsselung
ssl = required
ssl_server_cert_file = /var/lib/dehydrated/certs/{{ mailserver_domain }}/fullchain.pem
ssl_server_key_file = /var/lib/dehydrated/certs/{{ mailserver_domain }}/privkey.pem


##
## Dovecot services
##

service imap-login {
    # STARTTLS wird nicht mehr empfohlen: https://tools.ietf.org/html/rfc8314
    inet_listener imap {
        # deaktiviere STARTTLS (port 143) durch setzen auf port 0
        port = 0
    }

    inet_listener imaps {
        port = {{ mailserver_port_imap }}
        ssl = yes
  }
}

service managesieve-login {
    inet_listener sieve {
        port = 4190
    }
}

service lmtp {
    unix_listener /var/spool/postfix/private/dovecot-lmtp {
        mode = 0660
        group = postfix
        user = postfix
    }

    user = {{ mailserver_vmail_user }}
}

service auth {
    ### Auth socket für Postfix
    unix_listener /var/spool/postfix/private/auth {
        mode = 0660
        user = postfix
        group = postfix
    }

    ### Auth socket für LMTP-Dienst
    unix_listener auth-userdb {
        mode = 0660
        user = {{ mailserver_vmail_user }}
        group = {{ mailserver_vmail_user }}
    }
}


##
##  Protocol settings
##
protocol imap {
    mail_plugins = quota imap_quota imap_sieve
    mail_max_userip_connections = 20
    imap_idle_notify_interval = 29 mins
}

protocol lmtp {
    postmaster_address = {{ mailserver_postmaster }}
    mail_plugins = sieve notify push_notification
}


##
## Client authentication
##
auth_mechanisms = plain login
auth_username_format = %{user | lower}
mysql localhost {
    user = {{ mailserver_vmail_db_user }}
    password = {{ mailserver_vmail_db_pass }}
    dbname = {{ mailserver_vmail_db }}
    host = localhost
}
passdb sql_backend {
    driver = sql
    sql_driver = mysql
    default_password_scheme = BLF-CRYPT
    sql_query = SELECT username as user, password as password, \
            homedir AS userdb_home, maildir AS userdb_mail, \
            concat('*:bytes=', quota) as userdb_quota_rule, uid AS userdb_uid, gid AS userdb_gid \
        FROM mailbox \
        WHERE username = '%{user}' AND active = '1' \
            AND ( access_restriction = 'ALL' OR LOCATE( '%{user}', access_restriction ) > 0 )

}
userdb sql_backend {
    driver = sql
    sql_driver = mysql
    sql_query = SELECT homedir AS home, maildir AS mail, \
            concat('*:bytes=', quota) as quota_rule, uid, gid \
        FROM mailbox WHERE username = '%{user}'
}


##
## Address tagging
##
recipient_delimiter = +


##
## Mail location
##
mail_uid = {{ mailserver_vmail_user }}
mail_gid = {{ mailserver_vmail_user }}

mail_driver = maildir
mail_path = ~/mail
mailbox_list_layout = {{ mailserver_vmail_mailbox_layout }}
mail_home = {{ mailserver_vmail_path }}/%{user | domain }/%{user | username }


##
## Mailbox configuration
##

namespace inbox {
    inbox = yes

    mailbox Junk {
        auto = subscribe
        special_use = \Junk
    }

    mailbox Trash {
        auto = subscribe
        special_use = \Trash
    }

    mailbox Drafts {
        auto = subscribe
        special_use = \Drafts
    }

    # For \Sent mailboxes there are two widely used names. We'll mark both of
    # them as \Sent. User typically deletes one of them if duplicates are created.
    mailbox Sent {
        auto = subscribe
        special_use = \Sent
    }
    mailbox "Sent Messages" {
        special_use = \Sent
    }
}


##
## Mail plugins
##
sieve_plugins {
    sieve_imapsieve = yes
    sieve_extprograms = yes
}
sieve_script spam-global {
    type = before
    path = {{ mailserver_vmail_sieve_path }}/spam-global.sieve
}
sieve_script personal {
    type = personal
    path = {{ mailserver_vmail_sieve_path }}/%{user | domain}/%{user | username}/scripts
    active_path ={{ mailserver_vmail_sieve_path }}/%{user | domain}/%{user | username}/active-script.sieve
}

###
### Spam learning
###
# From Mailbox to Spam
mailbox Spam {
    sieve_script spam {
        type = before
        cause = copy
        path = {{ mailserver_vmail_sieve_path }}/learn-spam.sieve
    }
}

# From Spam to another folder (learn HAM)
imapsieve_from Spam {
    sieve_script ham {
        type = before
        cause = copy
        path = {{ mailserver_vmail_sieve_path }}/learn-ham.sieve
    }
}

sieve_global_extensions {
    vnd.dovecot.pipe = yes
}

quota "User quota" {
    driver = count
}
quota_exceeded_message = User %{user} has exceeded the storage volume. / User %{user} has exhausted allowed storage space.
